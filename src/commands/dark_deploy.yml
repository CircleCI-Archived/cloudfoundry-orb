parameters:
  appname:
    type: string
    description: App Name
  manifest:
    type: string
    description: The Cloud Foundry manifest for this environment
  package:
    type: string
    description: path to the asset/package to push
  domain:
    type: string
    description: Cloud Foundry domain (a "dark" sub-domain will be used on this.)
  dark_subdomain:
    type: string
    description: Cloud Foundry dark domain to prefix domain (i.e. <dark_subdomain>.<domain>, defaults to "dark")
    default: dark
steps:
  - run:
      name: Cloud Foundry Dark Deployment
      command: |
        cf push --no-start <<parameters.appname>>-dark -f <<parameters.manifest>> -p <<parameters.package>> -n <<parameters.dark_subdomain>> -d <<parameters.domain>>
        cf set-env <<parameters.appname>>-dark CIRCLE_BUILD_NUM ${CIRCLE_BUILD_NUM}
        cf set-env <<parameters.appname>>-dark CIRCLE_SHA1 ${CIRCLE_SHA1}
        cf set-env <<parameters.appname>>-dark CIRCLE_WORKFLOW_ID ${CIRCLE_WORKFLOW_ID}
        cf set-env <<parameters.appname>>-dark CIRCLE_PROJECT_USERNAME ${CIRCLE_PROJECT_USERNAME}
        cf set-env <<parameters.appname>>-dark CIRCLE_PROJECT_REPONAME ${CIRCLE_PROJECT_REPONAME}

        # Push as "dark" instance (URL in manifest)
        cf start <<parameters.appname>>-dark
        # Ensure dark route is exclusive to dark app
        cf unmap-route <<parameters.appname>> <<parameters.domain>> -n <<parameters.dark_subdomain>> || echo "Already exclusive"
